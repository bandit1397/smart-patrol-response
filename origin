/* âœ… ê²€ìƒ‰ */
function searchAndShow(){
  const kw=document.getElementById("keyword").value.trim();
  if(!kw){ alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥í•˜ì„¸ìš”."); return; }
  clearMarkers();
  const kwNoSpace=kw.replace(/\s+/g,"").toLowerCase();
  if(kwNoSpace.length<2){ alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥"); return; }

  const res=Object.keys(lampData).filter(id=>{
    const d=lampData[id];
    const name=normalizeText(d.ê³ ìœ ì´ë¦„);
    if(name===kwNoSpace) return true;
    if(/^l\d+$/i.test(d.ê³ ìœ ì´ë¦„)&&d.ê³ ìœ ì´ë¦„.toLowerCase().endsWith(kwNoSpace)) return true;
    if(isSequenceMatch(name,kwNoSpace)) return true;
    if(normalizeText(d.ì „í™”ë²ˆí˜¸).includes(kwNoSpace)) return true;
    if([d.ì£¼ì†Œ,d.ë¶„ë¥˜,d.íŠ¹ì´ì‚¬í•­].some(f=>isSequenceMatch(normalizeText(f),kwNoSpace))) return true;
    return false;
  }).map(id=>({id,pos:parseCoords(lampData[id].ì¢Œí‘œ)}));

  if(res.length===0){ alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"); return; }
  const bounds=new google.maps.LatLngBounds();
  res.forEach(r=>{addMarker(r.id,r.pos,"blue");bounds.extend(r.pos);});
  map.fitBounds(bounds);
}
/* ------------------------ âœ… ì§€ë„ ê¸°ëŠ¥ ------------------------ */
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:{lat:37.3857,lng:126.6586},zoom:15});
  infoWindow=new google.maps.InfoWindow();
  map.addListener("click",e=>{
    lastClickedCoord=`${e.latLng.lat().toFixed(6)},${e.latLng.lng().toFixed(6)}`;
    document.getElementById("clickedCoords").innerText=`ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;
  });
}
function copyCoords(){ if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”."); return; } navigator.clipboard.writeText(lastClickedCoord).then(()=>alert("âœ… ë³µì‚¬ë¨: "+lastClickedCoord)); }
function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }
function addMarker(id,pos,color){
  const m=new google.maps.Marker({position:pos,map,label:id,icon:{url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`}});
  m.addListener("click", () => {
    const data = lampData[id];
    infoWindow.setContent(`
      <div style="min-width:150px;">
        <strong>${data.ê³ ìœ ì´ë¦„}</strong><br/>
        <b>ë¶„ë¥˜:</b> ${data.ë¶„ë¥˜}<br/>
        <b>ì „í™”ë²ˆí˜¸:</b> ${data.ì „í™”ë²ˆí˜¸}<br/>
        <b>ì£¼ì†Œ:</b> ${data.ì£¼ì†Œ}<br/>
        <b>íŠ¹ì´ì‚¬í•­:</b> ${data.íŠ¹ì´ì‚¬í•­}
      </div>
  `  );
    infoWindow.open(map, m);
  });
  m.addListener("dblclick",()=>{const c=lampData[id].ì¢Œí‘œ.split(",");window.open(`https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`,"_blank");});
  markers.push(m);
}



let map, infoWindow;
let lastClickedCoord = null;
let markers = [];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 37.3857, lng: 126.6586 },
    zoom: 15
  });
  infoWindow = new google.maps.InfoWindow();

  // ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ ë™ì‘
  map.addListener("click", e => {
    // 1) í´ë¦­ ì¢Œí‘œ ì €ì¥
    lastClickedCoord = `${e.latLng.lat().toFixed(6)},${e.latLng.lng().toFixed(6)}`;
    document.getElementById("clickedCoords").innerText =
      `ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;

    // 2) ê¸°ì¡´ ë§ˆì»¤ ì œê±° í›„ ìƒˆ ë¹¨ê°„ ë§ˆì»¤ ì¶”ê°€
    clearMarkers();
    const pos = { lat: e.latLng.lat(), lng: e.latLng.lng() };
    addMarker("ì„ íƒìœ„ì¹˜", pos, "red");

    // 3) êµ¬ê¸€ ì§€ë„ ê¸¸ì°¾ê¸° ë§í¬ ìë™ ë³µì‚¬
    const shareLink =
      `https://www.google.com/maps/dir/?api=1&destination=${lastClickedCoord}`;
    navigator.clipboard.writeText(shareLink)
      .then(() => {
        alert("âœ… ê¸¸ì°¾ê¸° ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ ì¹´í†¡ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!");
      })
      .catch(() => {
        alert("âš ï¸ ë³µì‚¬ ì‹¤íŒ¨. ë§í¬: " + shareLink);
      });
  });
}

// ì¢Œí‘œ ë³µì‚¬ ë²„íŠ¼ìš©
function copyCoords() {
  if (!lastClickedCoord) {
    alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
    return;
  }
  const shareLink =
    `https://www.google.com/maps/dir/?api=1&destination=${lastClickedCoord}`;
  navigator.clipboard.writeText(shareLink)
    .then(() => alert("âœ… ë³µì‚¬ë¨: " + shareLink));
}

// ë§ˆì»¤ ì´ˆê¸°í™”
function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

// ë§ˆì»¤ ì¶”ê°€
function addMarker(id, pos, color) {
  const m = new google.maps.Marker({
    position: pos,
    map,
    label: id,
    icon: {
      url: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`
    }
  });

  // lampDataì— ì •ì˜ëœ ë§ˆì»¤ì¼ ê²½ìš°ë§Œ ìƒì„¸ì •ë³´/ê¸¸ì°¾ê¸° ì´ë²¤íŠ¸ ë¶€ì—¬
  if (typeof lampData !== "undefined" && lampData[id]) {
    m.addListener("click", () => {
      const data = lampData[id];
      infoWindow.setContent(`
        <div style="min-width:150px;">
          <strong>${data.ê³ ìœ ì´ë¦„}</strong><br/>
          <b>ë¶„ë¥˜:</b> ${data.ë¶„ë¥˜}<br/>
          <b>ì „í™”ë²ˆí˜¸:</b> ${data.ì „í™”ë²ˆí˜¸}<br/>
          <b>ì£¼ì†Œ:</b> ${data.ì£¼ì†Œ}<br/>
          <b>íŠ¹ì´ì‚¬í•­:</b> ${data.íŠ¹ì´ì‚¬í•­}
        </div>
      `);
      infoWindow.open(map, m);
    });

    // lampData ë§ˆì»¤ ë”ë¸”í´ë¦­ ì‹œ â†’ êµ¬ê¸€ì§€ë„ ê¸¸ì°¾ê¸° ì—´ê¸°
    m.addListener("dblclick", () => {
      const c = lampData[id].ì¢Œí‘œ.split(",");
      window.open(
        `https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`,
        "_blank"
      );
    });
  }

  markers.push(m);
}

 // âœ… í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([newLog], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "patrol_log.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  alert(`âœ… ${activePatrol.task.id} (${activePatrol.key.split("|")[1]}) ìˆœì°° ì™„ë£Œ!`);
  activePatrol=null;
  showUpcomingPatrols();
}
