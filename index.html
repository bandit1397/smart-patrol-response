100% ê·¸ëŒ€ë¡œ ìœ ì§€í•œ í†µí•© HTMLì…ë‹ˆë‹¤.

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì¶œë™/ìˆœì°° ì‹œìŠ¤í…œ (Leaflet ë§ˆì»¤ í´ë¦­ ìƒ‰ìƒ + ì§€ë„ í´ë¦­ ì¢Œí‘œ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
#map { height: 100%; width: 100%; }
#panel { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: #fff; padding: 10px; border-radius: 5px; max-width: 400px; width: 90%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
#panel input, #panel button { width: 100%; margin: 5px 0; padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #007bff; }
#panel button { cursor: pointer; color: #fff; background: #007bff; border: none; }
#clickedCoords { background:#eef6ff; border:1px solid #007bff; text-align:center; padding:6px; border-radius:4px; font-size:13px; }
#upcomingPanel { position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh; overflow-y:auto; background: rgba(255,255,255,0.95); border:1px solid #007bff; border-radius:5px; padding:10px; font-size:14px; z-index:1000; box-shadow:2px 2px 5px rgba(0,0,0,0.2); cursor:pointer; }
#upcomingPanel h4 { margin:0 0 5px; color:#007bff; font-size:16px; }
#upcomingList { list-style:none; margin:0; padding:0; }
#upcomingList li { padding:5px 8px; border-bottom:1px solid #ddd; cursor:pointer; border-radius:3px; user-select:none; }
#upcomingList li:hover { background:#eef6ff; }
#upcomingPanel.hidden { width:50px; height:40px; padding:5px; overflow:hidden; cursor:pointer; }
#upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display:none; }
#upcomingPanel.hidden::after { content:"â°"; position:absolute; top:10px; left:15px; font-size:20px; color:#007bff; }
</style>
</head>
<body>

<div id="panel">
  <label>ìˆœì°°ì¹´í…Œê³ ë¦¬:</label>
  <ul id="categoryList" style="display:flex; gap:10px; justify-content:center; padding:0; margin:5px 0; list-style:none;">
    <li data-cat="ì•ˆì „ì¡°ì¹˜" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">ì•ˆì „ì¡°ì¹˜</li>
    <li data-cat="?" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">?</li>
  </ul>
  <input type="text" id="keyword" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ì•ˆì–‘ì²œ 9-2, ê³µì¤‘ì „í™”, ì•ˆì „ì¡°ì¹˜ ë“±)">
  <div style="display:flex; gap:5px;">
    <button onclick="searchAndShow()" style="flex:1;">ê²€ìƒ‰</button>
    <button onclick="resetSearch()" style="flex:1; background:#6c757d;">ì´ˆê¸°í™”</button>
  </div>
  <div id="clickedCoords">ğŸ“</div>
  <div style="display:flex; gap:5px; margin-top:5px;">
    <button onclick="completePatrol()" style="flex:1; background:#28a745;">âœ… ìˆœì°° ì™„ë£Œ</button>
    <button onclick="navigateToPatrol()" style="flex:1;">ğŸ“ ê¸¸ì°¾ê¸°</button>
    <button onclick="shareKakaoLink()" style="flex:1; background:#ff9900;">ğŸ’¬ ì¹´í†¡ ê³µìœ </button>
  </div>
</div>

<div id="upcomingPanel">
  <h4>â° ìˆœì°° í›„ ìˆœì°°ì™„ë£Œ ìš”ë§</h4>
  <ul id="upcomingList"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="lampData.js"></script>
<script src="patrolSchedule.js"></script>
<script>
let map = L.map('map').setView([37.3857, 126.6586], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = L.markerClusterGroup();
let searchMode = false;
let lastClickedCoord = "";
let activeCategories = ["ì•ˆì „ì¡°ì¹˜"];
let activePatrol = null;
let completedPatrols = new Set(JSON.parse(localStorage.getItem("patrol_" + new Date().toISOString().slice(0,10)) || "[]"));
let selectedMarker = null; // í´ë¦­ëœ ë§ˆì»¤ ì €ì¥
let clickMarker = null; // ì§€ë„ í´ë¦­ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë§ˆì»¤ ì €ì¥

function parseCoords(s){ const [lat,lng]=s.split(",").map(Number); return [lat,lng]; }
function pad(n){ return n.toString().padStart(2,"0"); }

function addMarker(id, pos, color="blue") {
  const icon = L.icon({
    iconUrl:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
    iconSize:[32,32],
    iconAnchor:[16,32]
  });

  const m = L.marker(pos, {title:id, icon: icon});

  m.on('click', ()=> {
    const data = lampData[id];
    lastClickedCoord = data.ì¢Œí‘œ;
    document.getElementById("clickedCoords").innerText = `ğŸ“ ì„ íƒ: ${lastClickedCoord}`;

    if(selectedMarker) {
      selectedMarker.setIcon(L.icon({
        iconUrl:`http://maps.google.com/mapfiles/ms/icons/blue-dot.png`,
        iconSize:[32,32],
        iconAnchor:[16,32]
      }));
    }
    m.setIcon(L.icon({
      iconUrl:`http://maps.google.com/mapfiles/ms/icons/red-dot.png`,
      iconSize:[32,32],
      iconAnchor:[16,32]
    }));
    selectedMarker = m;

    const popupContent = `
      <div style="min-width:150px;">
        <strong>ë¶„ë¥˜:</strong> ${data.ë¶„ë¥˜ || ""}<br/>
        <strong>ê³ ìœ ì´ë¦„:</strong> ${data.ê³ ìœ ì´ë¦„ || ""}<br/>
        <strong>ì „í™”ë²ˆí˜¸:</strong> ${data.ì „í™”ë²ˆí˜¸ || ""}<br/>
        <strong>ì£¼ì†Œ:</strong> ${data.ì£¼ì†Œ || ""}<br/>
        <strong>íŠ¹ì´ì‚¬í•­:</strong> ${data.íŠ¹ì´ì‚¬í•­ || ""}<br/>
        <strong>ì¢Œí‘œ:</strong> ${data.ì¢Œí‘œ || ""}
      </div>
    `;
    m.bindPopup(popupContent).openPopup();
  });

  markers.addLayer(m);
}

function clearMarkers(){ markers.clearLayers(); selectedMarker=null; }

function searchAndShow() {
  const kw=document.getElementById("keyword").value.trim();
  if(!kw){ alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥"); return; }
  searchMode=true;
  clearMarkers();
  const normalize = s=> (s||"").toLowerCase().replace(/[\s\-\_\.,\/\(\)\[\]#]/g,"");
  const kwNorm = normalize(kw);
  if(kwNorm.length<2){ alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ"); return; }
  const regex=new RegExp(kwNorm.split("").join(".*"),"i");

  const res=Object.keys(lampData).filter(id=>{
    const d=lampData[id];
    const fields=[d.ê³ ìœ ì´ë¦„,d.ì „í™”ë²ˆí˜¸,d.ì£¼ì†Œ,d.ë¶„ë¥˜,d.íŠ¹ì´ì‚¬í•­];
    return fields.some(f=>{
      const fn=normalize(f);
      return regex.test(fn)||fn.includes(kwNorm);
    });
  }).map(id=>({id,pos:parseCoords(lampData[id].ì¢Œí‘œ)}));

  if(res.length===0){ alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"); return; }

  res.forEach(r=>addMarker(r.id,r.pos));
  map.addLayer(markers);
  const group = L.featureGroup(res.map(r=>L.marker(r.pos)));
  map.fitBounds(group.getBounds().pad(0.2));
}

function resetSearch(){ 
  searchMode=false; 
  clearMarkers(); 
  document.getElementById("keyword").value=""; 
  lastClickedCoord=""; 
  document.getElementById("clickedCoords").innerText="ğŸ“"; 
  map.setView([37.3857,126.6586],15); 
}

// ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ í‘œì‹œ
map.on('click', function(e){
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);
  lastClickedCoord = `${lat},${lng}`;
  document.getElementById("clickedCoords").innerText = `ğŸ“ ì„ íƒ: ${lastClickedCoord}`;

  // ê¸°ì¡´ í´ë¦­ ë§ˆì»¤ ì œê±°
  if(clickMarker) map.removeLayer(clickMarker);

  // ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
  clickMarker = L.marker([lat,lng], {
    icon: L.icon({
      iconUrl: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
      iconSize: [32,32],
      iconAnchor: [16,32]
    })
  }).addTo(map);
});

function navigateToPatrol(){
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì¢Œí‘œ ì„ íƒ"); return; }
  const [lat,lng]=lastClickedCoord.split(",");
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const startLat=pos.coords.latitude.toFixed(6), startLng=pos.coords.longitude.toFixed(6);
      const appUrl=`kakaomap://route?sp=${startLat},${startLng}&ep=${lat},${lng}&by=CAR`;
      const webUrl=`https://map.kakao.com/link/to/ì„ íƒìœ„ì¹˜,${lat},${lng}`;
      if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
        window.location.href=appUrl;
        setTimeout(()=>window.open(webUrl,"_blank"),1500);
      } else { window.open(webUrl,"_blank"); }
    }, ()=>window.open(`https://map.kakao.com/link/to/ì„ íƒìœ„ì¹˜,${lat},${lng}`,"_blank"));
  } else { window.open(`https://map.kakao.com/link/to/ì„ íƒìœ„ì¹˜,${lat},${lng}`,"_blank"); }
}

function shareKakaoLink(){
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì¢Œí‘œ ì„ íƒ"); return; }
  const [lat,lng] = lastClickedCoord.split(",");
  const url = `https://map.kakao.com/link/map/ì„ íƒìœ„ì¹˜,${lat},${lng}`;

  if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
    window.open(`kakaotalk://send?text=${encodeURIComponent(url)}`, "_blank");
  } else {
    // URL ìë™ ë³µì‚¬
    navigator.clipboard.writeText(url).then(() => {
      alert("âœ… URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");  // ì´ì „ prompt ëŒ€ì‹  ë³µì‚¬ ì•Œë¦¼
    }).catch(() => {
      prompt("ë³µì‚¬ ì‹¤íŒ¨! ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:", url);
    });
  }
}

function completePatrol(){
  if(!activePatrol){ alert("ğŸš« ì§„í–‰ ì¤‘ì¸ ìˆœì°° ì—†ìŒ"); return; }
  completedPatrols.add(activePatrol.key);
  localStorage.setItem("patrol_" + new Date().toISOString().slice(0,10), JSON.stringify([...completedPatrols]));
  const patrolId=activePatrol.task.id;
  const data=lampData[patrolId];
  const patrolTime=new Date().toLocaleString("ko-KR");
  const logLine=`ì•„ì´ë””:${patrolId}, ìˆœì°°ì‹œê°„:${patrolTime}, ê³ ìœ ì´ë¦„:${data?.ê³ ìœ ì´ë¦„||"ì •ë³´ì—†ìŒ"}, ì£¼ì†Œ:${data?.ì£¼ì†Œ||"ì£¼ì†Œì—†ìŒ"}\n`;
  const todayKey="patrol_text_log_" + new Date().toISOString().slice(0,10);
  const existing=localStorage.getItem(todayKey)||"";
  localStorage.setItem(todayKey, existing+logLine);
  alert(`âœ… ${patrolId} (${activePatrol.key.split("|")[1]}) ìˆœì°° ì™„ë£Œ!`);
  activePatrol=null;
  showUpcomingPatrols();
}

function getActivePatrolSchedule(){
  let combined=[];
  activeCategories.forEach(cat=>{ if(patrolSchedules[cat]) combined=combined.concat(patrolSchedules[cat]); });
  return combined;
}

function showUpcomingPatrols(){
  const now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const list=document.getElementById("upcomingList");
  list.innerHTML="";
  const upcoming=[];
  const patrolSchedule=getActivePatrolSchedule();
  patrolSchedule.forEach(task=>{
    if(!(new Date(now.toISOString().slice(0,10))>=new Date(task.startDate) && new Date(now.toISOString().slice(0,10))<=new Date(task.endDate))) return;
    if(!task.daysOfWeek.includes(now.getDay())) return;
    task.timeRanges.forEach(r=>{
      const [sH,sM]=r.start.split(":").map(Number);
      const [eH,eM]=r.end.split(":").map(Number);
      const startM=sH*60+sM-30, endM=eH*60+eM+30;
      const isOngoing=nowM>=sH*60+sM && nowM<=eH*60+eM;
      const isInWindow=nowM>=startM && nowM<=endM;
      const patrolKey=`${task.id}|${r.start}~${r.end}`;
      if(isInWindow && !completedPatrols.has(patrolKey)) upcoming.push({task,hour:sH,minute:sM,endHour:eH,endMinute:eM,key:patrolKey,isInTime:isOngoing});
    });
  });
  if(upcoming.length===0){ list.innerHTML="<li>âœ… ì˜ˆì • ì—†ìŒ</li>"; return; }
  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item => {
  const li = document.createElement("li");
  li.style.color = item.isInTime ? "blue" : "black";
  li.textContent = `${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;

  li.onclick = () => {
    activePatrol = { task: item.task, hour: item.hour, minute: item.minute, key: item.key };
    
    // ì„ íƒí•œ ìˆœì°° ëŒ€ìƒì˜ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
    const patrolId = item.task.id;
    const data = lampData[patrolId];
    if (!data || !data.ì¢Œí‘œ) { alert("âš ï¸ ì¢Œí‘œ ì •ë³´ ì—†ìŒ"); return; }
    lastClickedCoord = data.ì¢Œí‘œ;
    document.getElementById("clickedCoords").innerText = `ğŸ“ ì„ íƒ: ${lastClickedCoord}`;

    // ë°”ë¡œ ê¸¸ì°¾ê¸° ì‹¤í–‰
    navigateToPatrol();
  };

  list.appendChild(li);
 });
}

document.querySelectorAll("#categoryList li").forEach(li=>{
  li.addEventListener("click", ()=>{
    const cat=li.getAttribute("data-cat");
    if(activeCategories.includes(cat)){
      activeCategories=activeCategories.filter(c=>c!==cat);
      li.style.background="white"; li.style.color="#007bff"; li.style.border="1px solid #007bff";
    } else {
      activeCategories.push(cat);
      li.style.background="#007bff"; li.style.color="white"; li.style.border="1px solid #007bff";
    }
    showUpcomingPatrols();
  });
});

document.getElementById("upcomingPanel").addEventListener("click",e=>{
  if(e.target.tagName.toLowerCase()!=="li") e.currentTarget.classList.toggle("hidden");
});

showUpcomingPatrols();
</script>

</body>
</html>


