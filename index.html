<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ğŸš“ ê°€ë¡œë“± ìœ„ì¹˜ ê¸°ë°˜ í˜„ì¥ ì¶œë™ ì‹œìŠ¤í…œ (ìˆ˜ë™ ìˆœì°° ë²„ì „)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    h3 { text-align: center; background: #007bff; color: white; margin: 0; padding: 10px; }
    #panel { padding: 10px; text-align: center; max-width: 400px; margin: 10px auto; }
    #panel input, #panel button {
      width: 90%; max-width: 350px; padding: 10px; margin: 5px auto;
      font-size: 16px; display: block; border: 1px solid #ccc; border-radius: 5px;
    }
    #map { height: 70vh; width: 100%; }
    #clickedCoords {
      width: 90%; max-width: 350px; padding: 8px; margin: 5px auto;
      border: 1px solid #007bff; background: #eef6ff; font-size: 14px;
      border-radius: 5px; text-align: center;
    }
    #copyBtn {
      width: 90%; max-width: 350px; background: #ff9800; color: white;
      border: none; padding: 8px; border-radius: 5px; cursor: pointer;
    }
    #completeBtn {
      background: #28a745; color: white; border: none;
      padding: 10px; border-radius: 5px; font-size: 16px;
      cursor: pointer; width: 90%; max-width: 350px; margin: 10px auto; display: block;
    }
    #navigateBtn {
      background:#007bff; color:white; border:none;
      padding:10px; border-radius:5px; font-size:16px;
      cursor:pointer; width:90%; max-width:350px; margin:10px auto; display:block;
    }
    #upcomingPanel {
      position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh;
      overflow-y: auto; background: rgba(255,255,255,0.95);
      border: 1px solid #007bff; border-radius: 5px; padding: 10px;
      font-size: 14px; z-index: 9999; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease; cursor: pointer;
    }
    #upcomingPanel h4 { margin: 0 0 5px; font-size: 16px; color: #007bff; }
    #upcomingList { list-style: none; padding: 0; margin: 0; }
    #upcomingList li { padding: 5px 8px; border-bottom: 1px solid #ddd; cursor: pointer; border-radius: 3px; user-select: none; }
    #upcomingList li:hover { background: #eef6ff; }
    #upcomingPanel.hidden { width: 50px; height: 40px; padding: 5px; overflow: hidden; cursor: pointer; }
    #upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display: none; }
    #upcomingPanel.hidden::after { content: "â°"; position: absolute; top: 10px; left: 15px; font-size: 20px; color: #007bff; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5qR9rGB6Qv43IYSMoHKhArm5gJdapXGk&libraries=places"></script>
</head>
<body>
<h3>ğŸš“ í•¨ê»˜ ë§Œë“œëŠ” ìˆœì°°/ì¶œë™ poi(ì‹ ì •2)</h3>

<!-- âœ… íŒ¨ë„ UI -->
<div id="panel">
  <input type="text" id="keyword" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: L0, L003, ë²”ì, ë²” í”¼, ì „í™”ë²ˆí˜¸ ì¼ë¶€)" />
  <button onclick="searchAndShow()">ê²€ìƒ‰</button>
  <div id="clickedCoords">ğŸ“ ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ë©´ ì¢Œí‘œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
  <button id="copyBtn" onclick="copyCoords()">ì¢Œí‘œ ë³µì‚¬</button>
  <button id="completeBtn" onclick="completePatrol()">âœ… ìˆœì°° ì™„ë£Œ</button>
  <button id="navigateBtn" onclick="navigateToPatrol()">ğŸ“ Google Maps ê¸¸ì°¾ê¸°</button>
</div>

<div id="upcomingPanel">
  <h4>â° ìˆœì°° í›„ ìˆœì°°ì™„ë£Œ ìš”ë§</h4>
  <ul id="upcomingList"></ul>
</div>

<div id="map"></div>

<script>

/* âœ… ID ì •ê·œí™” í•¨ìˆ˜ */
function normalizeId(id) {
  return id.split("(")[0].trim().toUpperCase();
}

/* ------------------------ âœ… ë°ì´í„° ì •ì˜ ------------------------ */
const lampData = {

  "L001": { ë¶„ë¥˜:"ê°€ë¡œë“±", ê³ ìœ ì´ë¦„:"L001", ì „í™”ë²ˆí˜¸:"02-2345-4444", ì£¼ì†Œ:"ì„œìš¸ ì–‘ì²œêµ¬ í•©ì •ë™", íŠ¹ì´ì‚¬í•­:"ì¤‘ìš”", ì¢Œí‘œ:"37.391721,126.652404" },

  "L002": { ë¶„ë¥˜:"ê°€ë¡œë“±", ê³ ìœ ì´ë¦„:"L002", ì „í™”ë²ˆí˜¸:"02-2345-7744", ì£¼ì†Œ:"ì„œìš¸ ì–‘ì²œêµ¬ í•©ì •ë™", íŠ¹ì´ì‚¬í•­:"ì ê²€ í•„ìš”", ì¢Œí‘œ:"37.386138,126.658433" },

  "L003": { ë¶„ë¥˜:"ê°€ë¡œë“±", ê³ ìœ ì´ë¦„:"L003", ì „í™”ë²ˆí˜¸:"02-2345-4488", ì£¼ì†Œ:"", íŠ¹ì´ì‚¬í•­:"ì¤‘ìš”", ì¢Œí‘œ:"37.391747,126.652425" },

  "CV1": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV1", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ37ê¸¸", íŠ¹ì´ì‚¬í•­:"25.5.16~25.8.26. 22:00~23:00, 42í˜¸)", ì¢Œí‘œ:"37.526140,126.856032" },

  "CV2": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV2", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ24ê¸¸", íŠ¹ì´ì‚¬í•­:"7.5~8.4(ë§¤ì¼ 22~23ì‹œ)", ì¢Œí‘œ:"37.522740,126.854003" },

  "CV3": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV3", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ34ê¸¸", íŠ¹ì´ì‚¬í•­:"7.8~9.7(ë§¤ì¼ 22~23ì‹œ)", ì¢Œí‘œ:"37.524296,126.855753" },

  "CV4": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV4", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì‹ ëª©ë¡œ5 ëª©ë™ì‚¼ì„±ì•„íŒŒíŠ¸", íŠ¹ì´ì‚¬í•­:"5.22~8.21(ë§¤ì¼ 13~14, 22~23)", ì¢Œí‘œ:"37.517046,126.876516" },

  "CV5": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV5", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ëª©ëŒë¡œ23ê¸¸", íŠ¹ì´ì‚¬í•­:"4.15~8.14(ë§¤ì¼ 12~13ì‹œ)", ì¢Œí‘œ:"37.527701,126.859364" },

  "CV6": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV6", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì€í–‰ì •ë¡œ42 ì‹ ì„œê³ ë“±í•™êµ", íŠ¹ì´ì‚¬í•­:"6.8~9.7(ì›”~ê¸ˆ 8~9, 22~23ì‹œ)", ì¢Œí‘œ:"37.523921,126.860085" },

  "CV7": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV7", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ëª©ë™ë¡œ11ê¸¸ )", íŠ¹ì´ì‚¬í•­:"5.23~8.22(ë§¤ì¼ 23~24ì‹œ)", ì¢Œí‘œ:"37.522949,126.861280" },

  "CV8": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV8", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì¤‘ì•™ë¡œ52ê¸¸", íŠ¹ì´ì‚¬í•­:"7.15~8.14(ë§¤ì¼ 9~10, 21~22)", ì¢Œí‘œ:"37.525925,126.855922" },

  "CV9": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV9", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ëª©ë™ë¡œ19ê¸¸", íŠ¹ì´ì‚¬í•­:"7.8~8.7(ìˆœì°°ë¯¸ì‹¤ì‹œ)", ì¢Œí‘œ:"37.524588,126.861030" },

  "CV10": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV10", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ëª©ë™ë¡œ 193", íŠ¹ì´ì‚¬í•­:"7.19~8.17(11~12, 21~22))", ì¢Œí‘œ:"37.525567,126.858867" },

  "CV11": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV11", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì‹ ëª©ë¡œ5ê¸¸", íŠ¹ì´ì‚¬í•­:"7.19~8.18(13~14ì‹œ)", ì¢Œí‘œ:"37.517567,126.872267" },

  "CV12": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV12", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ354", íŠ¹ì´ì‚¬í•­:"7.18~8.17(15~16, 22~23)", ì¢Œí‘œ:"37.523919,126.876851" },

  "CV13": { ë¶„ë¥˜:"ë²”ì£„í”¼í•´ì", ê³ ìœ ì´ë¦„:"CV13", ì „í™”ë²ˆí˜¸:"", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ300", íŠ¹ì´ì‚¬í•­:"7.31~8.30(05~06, 19~20)", ì¢Œí‘œ:"37.524183,126.870829" },

  "PP1": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP1", ì „í™”ë²ˆí˜¸:"02-2696-2896", ì£¼ì†Œ:"ëª©ë™ë¡œ 189", íŠ¹ì´ì‚¬í•­:"ì œì¼ì€í–‰ ì•", ì¢Œí‘œ:"37.525392,126.864424" },

  "PP2": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP2", ì „í™”ë²ˆí˜¸:"02-2065-9837", ì£¼ì†Œ:"ì‹ ì •ì¤‘ì•™ë¡œ 81", íŠ¹ì´ì‚¬í•­:"í˜„ëŒ€ê³µì—…ì‚¬, ì ì‹¬ë°¥ìƒ ì•", ì¢Œí‘œ:"37.526729,126.860807" },

  "PP3": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP3", ì „í™”ë²ˆí˜¸:"02-2696-7731", ì£¼ì†Œ:"ì¤‘ì•™ë¡œ 326", íŠ¹ì´ì‚¬í•­:"ì¬ì •ë§ˆíŠ¸ ì• ë…¸ìƒ", ì¢Œí‘œ:"37.52496,126.850586" },

  "PP4": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP4", ì „í™”ë²ˆí˜¸:"02-2694-9260", ì£¼ì†Œ:"ì‹ ì›”ë¡œ 337", íŠ¹ì´ì‚¬í•­:"ìš°ë¦¬ì€í–‰ ì‹ ì •ë™ ê¸ˆìœµì„¼í„° ì• ë…¸ìƒ", ì¢Œí‘œ:"37.521859,126.858348" },

  "PP5": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP5", ì „í™”ë²ˆí˜¸:"02-2654-0174", ì£¼ì†Œ:"ì‹ ëª©ë¡œ 85", íŠ¹ì´ì‚¬í•­:"ì˜¤ëª©êµ7ë²ˆì¶œêµ¬ 240ë¯¸í„°(ê³¨ë“œì¹˜ê³¼ ì•)", ì¢Œí‘œ:"37.522277,126.874334" },

  "PP6": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP6", ì „í™”ë²ˆí˜¸:"02-2061-4217", ì£¼ì†Œ:"ëª©ë™ë™ë¡œ 152", íŠ¹ì´ì‚¬í•­:"ì‹ ì •2ì¹˜ì•ˆì„¼í„° ì•", ì¢Œí‘œ:"37.519302,126.870335" },

  "PP7": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP7", ì „í™”ë²ˆí˜¸:"02-2654-0136/02-2644-8193", ì£¼ì†Œ:"ì‹ ì •ë™ 129-85", íŠ¹ì´ì‚¬í•­:"ì²­êµ¬ì•„íŒŒíŠ¸ 101ë™ ì•", ì¢Œí‘œ:"37.51979,126.875529" },

  "PP8": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP8", ì „í™”ë²ˆí˜¸:"02-2654-0262", ì£¼ì†Œ:"ëª©ë™ë™ë¡œ 12ê¸¸ 60", íŠ¹ì´ì‚¬í•­:"í˜„ëŒ€ì•„íŒŒíŠ¸ ì…êµ¬", ì¢Œí‘œ:"37.522168,126.877685" },

  "PP9": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP9", ì „í™”ë²ˆí˜¸:"02-2061-6579", ì£¼ì†Œ:"ì‹ ëª©ë¡œ 5", íŠ¹ì´ì‚¬í•­:"ì‹ ì •ì‚¼ì„±ì œ2ê´€ë¦¬ì‚¬ë¬´ì†Œ ì•", ì¢Œí‘œ:"37.517164,126.876795" },

  "PP10": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP10", ì „í™”ë²ˆí˜¸:"02-2654-4323/02-2654-0138", ì£¼ì†Œ:"ì‹ ëª©ë¡œ 10", íŠ¹ì´ì‚¬í•­:"ëª©ë™í˜„ëŒ€ì•„íŒŒíŠ¸ ìƒê°€ ì•", ì¢Œí‘œ:"37.517926,126.876297" },

  "PP11": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP11", ì „í™”ë²ˆí˜¸:"02-2652-9138", ì£¼ì†Œ:"ì˜¤ëª©ë¡œ 245", íŠ¹ì´ì‚¬í•­:"ëª©ë™ì—­ ì§€í•˜ 1ì¸µ(í™”ì¥ì‹¤ ì•)", ì¢Œí‘œ:"37.526109,126.8643" },

  "PP12": { ë¶„ë¥˜:"ê³µì¤‘ì „í™”", ê³ ìœ ì´ë¦„:"PP12", ì „í™”ë²ˆí˜¸:"02-2061-0296", ì£¼ì†Œ:"ëª©ë™ë¡œ 225", íŠ¹ì´ì‚¬í•­:"í™ìµë³‘ì› ë³¸ê´€ 2ì¸µ", ì¢Œí‘œ:"37.528466,126.863688" },

};

const patrolSchedule = [
  { id:"L001", startDate:"2025-05-16", endDate:"2025-08-26", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"11:00", end:"12:00" }] },

  { id:"L002", startDate:"2025-05-16", endDate:"2025-08-26", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"11:00", end:"13:00" }] },

  { id:"L003", startDate:"2025-05-16", endDate:"2025-08-26", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"11:00", end:"16:00" }] },

  { id:"CV1(42í˜¸)", startDate:"2025-05-16", endDate:"2025-08-26", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"22:00", end:"23:00" }] },

  { id:"CV2(43í˜¸)", startDate:"2025-07-05", endDate:"2025-08-04", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"22:00", end:"23:00" }] },

  { id:"CV3(43í˜¸)", startDate:"2025-07-08", endDate:"2025-09-07", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"22:00", end:"23:00" }] },

  { id:"CV4(41í˜¸)", startDate:"2025-05-22", endDate:"2025-08-21", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"13:00", end:"14:00" },{ start:"22:00", end:"23:00" }] },

  { id:"CV5(42í˜¸)", startDate:"2025-04-15", endDate:"2025-08-14", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"12:00", end:"13:00" }] },

  { id:"CV6(43í˜¸)", startDate:"2025-06-08", endDate:"2025-09-07", daysOfWeek:[1,2,3,4,5], timeRanges:[{ start:"08:00", end:"09:00" },{ start:"22:00", end:"23:00" }] },

  { id:"CV7(43í˜¸)", startDate:"2025-05-23", endDate:"2025-08-22", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"23:00", end:"00:00" }] },

  { id:"CV8(42í˜¸)", startDate:"2025-07-15", endDate:"2025-08-14", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"09:00", end:"10:00" },{ start:"21:00", end:"22:00" }] },

  { id:"CV10(42í˜¸)", startDate:"2025-07-19", endDate:"2025-08-17", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"11:00", end:"12:00" },{ start:"21:00", end:"22:00" }] },

  { id:"CV11(41í˜¸)", startDate:"2025-07-19", endDate:"2025-08-18", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"13:00", end:"14:00" }] },

  { id:"CV11-1(41í˜¸)", startDate:"2025-07-19", endDate:"2025-08-18", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"17:00", end:"18:00" },{ start:"21:00", end:"22:00" }] },

  { id:"CV12(41í˜¸)", startDate:"2025-07-18", endDate:"2025-08-17", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"15:00", end:"16:00" },{ start:"22:00", end:"23:00" }] },

  { id:"CV13(41í˜¸)", startDate:"2025-07-31", endDate:"2025-08-30", daysOfWeek:[0,1,2,3,4,5,6], timeRanges:[{ start:"05:00", end:"06:00" },{ start:"19:00", end:"20:00" }] },

];

/* âœ… ìœ í‹¸ í•¨ìˆ˜ */
function isWithinDateRange(dateStr,startDateStr,endDateStr){ const d=new Date(dateStr); return d>=new Date(startDateStr)&&d<=new Date(endDateStr); }
function isDayAllowed(date,days){return days.includes(date.getDay());}
function parseCoords(s){const[a,b]=s.split(",").map(Number);return{lat:a,lng:b};}
function pad(n){ return n.toString().padStart(2,"0"); }
function normalizeText(str){ return (str||"").toLowerCase().replace(/[\s\-\_\.,]/g,""); }
function isSequenceMatch(text, keyword){ let idx=0; for(const ch of keyword){ idx=text.indexOf(ch, idx); if(idx === -1) return false; idx++; } return true; }
function deg2rad(d){return d*(Math.PI/180);}
function getDistanceM(c1,c2){
  const R=6371000;
  const dLat=deg2rad(c2.lat-c1.lat);
  const dLon=deg2rad(c2.lng-c1.lng);
  const a=Math.sin(dLat/2)**2+Math.cos(deg2rad(c1.lat))*Math.cos(deg2rad(c2.lat))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ */
function getTodayKey(){ return "patrol_" + new Date().toISOString().slice(0,10); }
function loadCompletedPatrols(){ const data=localStorage.getItem(getTodayKey()); return data?new Set(JSON.parse(data)):new Set(); }
function saveCompletedPatrols(){ localStorage.setItem(getTodayKey(), JSON.stringify([...completedPatrols])); }
let completedPatrols = loadCompletedPatrols();

/* âœ… ìƒíƒœ ë³€ìˆ˜ */
let activePatrol = null;
let lastClickedCoord = "";
let map, markers=[], infoWindow;

/* âœ… ì§€ë„ ì´ˆê¸°í™” */
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:{lat:37.3857,lng:126.6586},zoom:15});
  infoWindow=new google.maps.InfoWindow();
  map.addListener("click",e=>{
    lastClickedCoord=`${e.latLng.lat().toFixed(6)},${e.latLng.lng().toFixed(6)}`;
    document.getElementById("clickedCoords").innerText=`ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;
  });
}

/* âœ… GPS ìë™ì™„ë£Œ (ID ë§¤ì¹­ ê°œì„  ì ìš©) */
function checkProximityAndAutoComplete(coords) {
  if (!activePatrol) return;

  let patrolId = normalizeId(activePatrol.task.id);
  if (!lampData[patrolId]) {
    const matchKey = Object.keys(lampData).find(k => patrolId.startsWith(k));
    if (matchKey) {
      console.log(`âœ… ID ë³´ì •: ${patrolId} â†’ ${matchKey}`);
      patrolId = matchKey;
    } else {
      console.error(`ğŸš« ID ë§¤ì¹­ ì‹¤íŒ¨: ${activePatrol.task.id}`);
      return;
    }
  }

  const target = parseCoords(lampData[patrolId].ì¢Œí‘œ);
  const user = { lat: coords.latitude, lng: coords.longitude };
  const dist = getDistanceM(user, target);
  console.log(`ğŸ“ í˜„ì¬ ê±°ë¦¬: ${dist.toFixed(1)}m (${patrolId})`);

  if (dist <= 50 && !completedPatrols.has(activePatrol.key)) {
    completePatrol(true);
  }
}

/* âœ… ì¢Œí‘œ ë³µì‚¬ */
function copyCoords(){
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”."); return; }
  navigator.clipboard.writeText(lastClickedCoord).then(()=>alert("âœ… ë³µì‚¬ë¨: "+lastClickedCoord));
}

/* âœ… ë§ˆì»¤ ê´€ë¦¬ */
function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }
function addMarker(id,pos,color){
  const m=new google.maps.Marker({position:pos,map,label:id,icon:{url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`}});
  m.addListener("click", () => {
    const data = lampData[id];
    infoWindow.setContent(`
      <div style="min-width:150px;">
        <strong>${data.ê³ ìœ ì´ë¦„}</strong><br/>
        <b>ë¶„ë¥˜:</b> ${data.ë¶„ë¥˜}<br/>
        <b>ì „í™”ë²ˆí˜¸:</b> ${data.ì „í™”ë²ˆí˜¸}<br/>
        <b>ì£¼ì†Œ:</b> ${data.ì£¼ì†Œ}<br/>
        <b>íŠ¹ì´ì‚¬í•­:</b> ${data.íŠ¹ì´ì‚¬í•­}
      </div>
    `);
    infoWindow.open(map, m);
  });
  m.addListener("dblclick",()=>{const c=lampData[id].ì¢Œí‘œ.split(",");window.open(`https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`,"_blank");});
  markers.push(m);
}

/* âœ… ê²€ìƒ‰ */
function searchAndShow(){
  const kw=document.getElementById("keyword").value.trim();
  if(!kw){ alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥í•˜ì„¸ìš”."); return; }
  clearMarkers();
  const kwNoSpace=kw.replace(/\s+/g,"").toLowerCase();
  if(kwNoSpace.length<2){ alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥"); return; }

  const res=Object.keys(lampData).filter(id=>{
    const d=lampData[id];
    const name=normalizeText(d.ê³ ìœ ì´ë¦„);
    if(name===kwNoSpace) return true;
    if(/^l\d+$/i.test(d.ê³ ìœ ì´ë¦„)&&d.ê³ ìœ ì´ë¦„.toLowerCase().endsWith(kwNoSpace)) return true;
    if(isSequenceMatch(name,kwNoSpace)) return true;
    if(normalizeText(d.ì „í™”ë²ˆí˜¸).includes(kwNoSpace)) return true;
    if([d.ì£¼ì†Œ,d.ë¶„ë¥˜,d.íŠ¹ì´ì‚¬í•­].some(f=>isSequenceMatch(normalizeText(f),kwNoSpace))) return true;
    return false;
  }).map(id=>({id,pos:parseCoords(lampData[id].ì¢Œí‘œ)}));

  if(res.length===0){ alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"); return; }
  const bounds=new google.maps.LatLngBounds();
  res.forEach(r=>{addMarker(r.id,r.pos,"blue");bounds.extend(r.pos);});
  map.fitBounds(bounds);
}

/* âœ… ìˆœì°° ì™„ë£Œ */
function completePatrol(auto=false){
  if(!activePatrol){ if(!auto) alert("ğŸš« ì§„í–‰ ì¤‘ì¸ ìˆœì°°ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  if(completedPatrols.has(activePatrol.key)) return;

  completedPatrols.add(activePatrol.key);
  saveCompletedPatrols();

  const patrolId=activePatrol.task.id.split("(")[0];
  const data=lampData[patrolId];
  const time=new Date().toLocaleString("ko-KR");
  const logLine=`${auto?"[ìë™ì™„ë£Œ]":"[ìˆ˜ë™ì™„ë£Œ]"} ${patrolId} | ${time} | ${data?data.ì£¼ì†Œ:"ì£¼ì†Œ ì—†ìŒ"}\n`;

  const old=localStorage.getItem("patrol_text_log")||"";
  const newLog=old+logLine;
  localStorage.setItem("patrol_text_log",newLog);

  const blob=new Blob([newLog],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="patrol_log.txt";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);

  alert(`âœ… ${patrolId} ìˆœì°° ì™„ë£Œ! (${auto?"GPS ìë™":"ìˆ˜ë™"})`);
  activePatrol=null;
  showUpcomingPatrols();
}

/* âœ… ê¸¸ì°¾ê¸° */
function navigateToPatrol(){
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
  const [lat,lng]=lastClickedCoord.split(",");
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");
}

/* âœ… ì˜ˆì • ìˆœì°° í‘œì‹œ */
function showUpcomingPatrols(){
  const now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const list=document.getElementById("upcomingList");
  list.innerHTML="";
  const upcoming=[];

  patrolSchedule.forEach(task=>{
    if(!isWithinDateRange(now.toISOString().slice(0,10),task.startDate,task.endDate)) return;
    if(!isDayAllowed(now,task.daysOfWeek)) return;

    task.timeRanges.forEach(r=>{
      const [sH,sM]=r.start.split(":").map(Number);
      const [eH,eM]=r.end.split(":").map(Number);
      const startM=sH*60+sM-30;
      const endM=eH*60+eM+30;
      const isOngoing=nowM>=sH*60+sM && nowM<=eH*60+eM;
      const isInWindow=nowM>=startM && nowM<=endM;
      const patrolKey=`${task.id}|${r.start}~${r.end}`;

      if(isInWindow && !completedPatrols.has(patrolKey)){
        upcoming.push({task,hour:sH,minute:sM,endHour:eH,endMinute:eM,key:patrolKey,isInTime:isOngoing});
      }
    });
  });

  if(upcoming.length===0){ list.innerHTML="<li>âœ… ì˜ˆì • ì—†ìŒ</li>"; return; }

  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item=>{
    const li=document.createElement("li");
    li.style.color=item.isInTime?"blue":"black";
    li.textContent=`${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;
    li.onclick=()=>{
      activePatrol={task:item.task,hour:item.hour,minute:item.minute,key:item.key};
      const baseId=item.task.id.split("(")[0];
      if(!lampData[baseId]){ alert("í•´ë‹¹ IDì˜ ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const pos=parseCoords(lampData[baseId].ì¢Œí‘œ);
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${pos.lat},${pos.lng}`,"_blank");
    };
    list.appendChild(li);
  });
}

/* âœ… ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded",()=>{ document.getElementById("upcomingPanel").addEventListener("click",e=>{ if(e.target.tagName.toLowerCase()!=="li") e.currentTarget.classList.toggle("hidden"); }); });
window.onload = () => { 
  initMap(); 
  showUpcomingPatrols(); 
  setInterval(showUpcomingPatrols, 60000); 

  // âœ… GPS ê¶Œí•œ í™•ì¸ ë° ìë™ì™„ë£Œìš© watchPosition ê°œì„ 
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => {
        console.log("ğŸ“ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", pos.coords.latitude, pos.coords.longitude);
        checkProximityAndAutoComplete(pos.coords);
      },
      err => {
        alert("ğŸš« GPS ì˜¤ë¥˜: " + err.message + "\në¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”.");
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
    );
  } else {
    alert("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
};



</script>
</body>

</html>


