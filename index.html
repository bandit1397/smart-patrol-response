<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>íŠ¹ì • poi ê¸°ë°˜ ì¶œë™/ìˆœì°° ì‹œìŠ¤í…œ (Leaflet)</title>
<meta http-equiv="refresh" content="300">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
  h3 { text-align: center; background: #007bff; color: white; margin: 0; padding: 10px; }
  #panel { padding: 10px; text-align: center; max-width: 400px; margin: 10px auto; }
  #panel input, #panel button { width: 90%; max-width: 350px; padding: 10px; margin: 5px auto; font-size: 16px; display: block; border: 1px solid #ccc; border-radius: 5px; }
  #map { height: 70vh; width: 100%; }
  #clickedCoords { width: 90%; max-width: 350px; padding: 8px; margin: 5px auto; border: 1px solid #007bff; background: #eef6ff; font-size: 14px; border-radius: 5px; text-align: center; }
  #copyRouteBtn { width: 90%; max-width: 350px; background: #ff9800; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
  #completeBtn { background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 90%; max-width: 350px; margin: 10px auto; display: block; }
  #navigateBtn { background:#007bff; color:white; border:none; padding:10px; border-radius:5px; font-size:16px; cursor:pointer; width:90%; max-width:350px; margin:10px auto; display:block; }
  #upcomingPanel { position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.95); border: 1px solid #007bff; border-radius: 5px; padding: 10px; font-size: 14px; z-index: 9999; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease; cursor: pointer; }
  #upcomingPanel h4 { margin: 0 0 5px; font-size: 16px; color: #007bff; }
  #upcomingList { list-style: none; padding: 0; margin: 0; }
  #upcomingList li { padding: 5px 8px; border-bottom: 1px solid #ddd; cursor: pointer; border-radius: 3px; user-select: none; }
  #upcomingList li:hover { background: #eef6ff; }
  #upcomingPanel.hidden { width: 50px; height: 40px; padding: 5px; overflow: hidden; cursor: pointer; }
  #upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display: none; }
  #upcomingPanel.hidden::after { content: "â°"; position: absolute; top: 10px; left: 15px; font-size: 20px; color: #007bff; }
</style>
<script src="lampData.js"></script>
<script src="patrolSchedule.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-gpx@1.7.0/gpx.js"></script>

</head>
<body>
<h3>ğŸš“ í•¨ê»˜ ë§Œë“œëŠ” ìˆœì°°/ì¶œë™ poi(ì‹ ì •2)</h3>

<div id="panel">
  <label>ìˆœì°°ì¹´í…Œê³ ë¦¬:</label>
  <ul id="categoryList" style="list-style:none; padding:0; margin:5px auto; max-width:200px; display:flex; justify-content:center; gap:10px;">
    <li data-cat="ì•ˆì „ì¡°ì¹˜" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">ì•ˆì „ì¡°ì¹˜</li>
    <li data-cat="?" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">?</li>
  </ul>
  <input type="text" id="keyword" placeholder="í‚¤ì›Œë“œì…ë ¥(ì˜ˆ:ì•ˆì–‘ì²œ 9-2, ê³µì¤‘ì „í™”, ì•ˆì „ì¡°ì¹˜ ë“±)" />
  <div style="display:flex; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
    <button onclick="searchAndShow()">ê²€ìƒ‰</button>
    <button onclick="resetSearch()">ì´ˆê¸°í™”</button>
  </div>

  <!-- í´ë¦­ ì¢Œí‘œ ì˜ì—­ -->
  <div style="display:flex; align-items:center; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
    <div id="clickedCoords">ğŸ“</div>
    <button id="copyRouteBtn">ğŸ“‹ ìœ„ì¹˜ url ë³µì‚¬</button>
  </div>

  <!-- ìˆœì°°ì™„ë£Œ, ìˆœì°°ë¡œê·¸, ê¸¸ì°¾ê¸° ë²„íŠ¼ í•œ ì¤„ -->
  <div style="display:flex; flex-direction:row; justify-content:center; gap:5px; max-width:350px; margin:10px auto;">
  <button id="completeBtn" onclick="completePatrol()" style="flex:1; background:#28a745; color:white; border:none; padding:10px; border-radius:5px; font-size:14px; cursor:pointer;">âœ… ìˆœì°° ì™„ë£Œ</button>
  <button id="logBtn" onclick="toggleLogViewer()" style="flex:1; background:#ffc107; color:white; border:none; padding:10px; border-radius:5px; font-size:14px; cursor:pointer;">ğŸ“‹ ìˆœì°° ë¡œê·¸</button>
  <button id="navigateBtn" onclick="navigateToPatrol()" style="flex:1; background:#007bff; color:white; border:none; padding:10px; border-radius:5px; font-size:14px; cursor:pointer;">ğŸ“ ê¸¸ì°¾ê¸°</button>
  </div>

  <!-- ë¡œê·¸ textarea -->
  <textarea id="logContent" readonly
    style="width:100%; height:150px; font-size:14px; padding:5px; border:1px solid #007bff; border-radius:5px; display:none; margin-top:5px;">
  </textarea>
</div>


<div id="upcomingPanel">
  <h4>â° ìˆœì°° í›„ ìˆœì°°ì™„ë£Œ ìš”ë§</h4>
  <ul id="upcomingList"></ul>
</div>
  
<div id="map"></div>

<script>
let activeCategories = ["ì•ˆì „ì¡°ì¹˜"];
let activePatrol = null;
let lastClickedCoord = "";
let map, markers = [], markerCluster;
let searchMode = false;
let completedPatrols = new Set(JSON.parse(localStorage.getItem("patrol_" + new Date().toISOString().slice(0,10)) || "[]"));
let lastClickedMarker = null;

/* ğŸ”´ ì—¬ê¸° ì¶”ê°€ */
const ROUTE_GPX_FILES = [
  "routes/patrol_2025-11-24_minimal.gpx",
  "routes/20260201191546-89077-data_minimal.gpx"
];
let gpxLayerGroup; // GPX ë ˆì´ì–´ ë¬¶ìŒ
/* ğŸ”´ ì—¬ê¸°ê¹Œì§€ */

function setActiveCategories(selectedCategories){
  activeCategories = selectedCategories.filter(cat => patrolSchedules.hasOwnProperty(cat));
  updatePatrolDisplay();
}

document.querySelectorAll("#categoryList li").forEach(li=>{
  li.addEventListener("click", ()=>{
    const cat = li.getAttribute("data-cat");
    if(activeCategories.includes(cat)){
      activeCategories = activeCategories.filter(c=>c!==cat);
      li.style.background="white"; li.style.color="#007bff"; li.style.border="1px solid #007bff";
    } else {
      activeCategories.push(cat);
      li.style.background="#007bff"; li.style.color="white"; li.style.border="1px solid #007bff";
    }
    updatePatrolDisplay();
  });
});

function getActivePatrolSchedule(){
  let combined=[];
  activeCategories.forEach(cat=>{ if(patrolSchedules[cat]) combined=combined.concat(patrolSchedules[cat]); });
  return combined;
}

function updatePatrolDisplay(){ showUpcomingPatrols(); }

function parseCoords(s){ const[a,b]=s.split(",").map(Number); return{lat:a,lng:b}; }
function pad(n){ return n.toString().padStart(2,"0"); }

function showUpcomingPatrols(){
  const now = new Date(), nowM = now.getHours()*60 + now.getMinutes();
  const list = document.getElementById("upcomingList"); 
  list.innerHTML = "";
  const upcoming = [];
  const patrolSchedule = getActivePatrolSchedule();

  patrolSchedule.forEach(task=>{
    // âœ… ë‚ ì§œ ë¹„êµ (UTC ë³´ì •)
    const todayStr = now.toISOString().slice(0,10);
    const todayDate = new Date(todayStr + "T00:00:00");
    const startDate = new Date(task.startDate + "T00:00:00");
    const endDate   = new Date(task.endDate + "T23:59:59"); // ì¢…ë£Œì¼ í¬í•¨

    if (!(todayDate >= startDate && todayDate <= endDate)) return;

    // ìš”ì¼ ì¡°ê±´
    if (!task.daysOfWeek.includes(now.getDay())) return;

    // ì‹œê°„ ì¡°ê±´
    task.timeRanges.forEach(r=>{
      const [sH,sM] = r.start.split(":").map(Number);
      const [eH,eM] = r.end.split(":").map(Number);
      const startM = sH*60 + sM - 30;
      const endM   = eH*60 + eM + 30;
      const isOngoing = nowM >= sH*60 + sM && nowM <= eH*60 + eM;
      const isInWindow = nowM >= startM && nowM <= endM;
      const patrolKey = `${task.id}|${r.start}~${r.end}`;

      if (isInWindow && !completedPatrols.has(patrolKey)) {
        upcoming.push({
          task, hour:sH, minute:sM, 
          endHour:eH, endMinute:eM, 
          key:patrolKey, isInTime:isOngoing
        });
      }
    });
  });

  if (upcoming.length===0){ 
    list.innerHTML="<li>âœ… ì˜ˆì • ì—†ìŒ</li>"; 
    return; 
  }

  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item=>{
    const li=document.createElement("li");
    li.style.color = item.isInTime ? "blue" : "black";
    li.textContent = `${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;
    li.onclick = () => {
      activePatrol = {task:item.task,hour:item.hour,minute:item.minute,key:item.key};
      const id = item.task.id;
      if (!lampData[id]) {
        alert("í•´ë‹¹ IDì˜ ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const pos = parseCoords(lampData[id].ì¢Œí‘œ);

      if (confirm("ğŸ“ ìˆœì°° ê¸¸ì°¾ê¸°ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ ë°”ë¡œ ì¹´ì¹´ì˜¤ë§µ ì‹¤í–‰ + ìˆœì°°ì™„ë£Œ ì²˜ë¦¬)")) {
        // âœ… ìˆœì°° ì™„ë£Œ ë¨¼ì € ì²˜ë¦¬
        completePatrol();

        // âœ… íŒì—… ì—†ì´ ë°”ë¡œ ì¹´ì¹´ì˜¤ë§µ ì—´ê¸°
        const kakaoUrl = `https://map.kakao.com/link/to/${encodeURIComponent(item.task.id)},${pos.lat},${pos.lng}`;
        const popup = window.open(kakaoUrl, "_blank");

        // âœ… íŒì—… ë‹«í˜ ê°ì§€ â†’ ì¦‰ì‹œ ì´ˆê¸°í™”ë©´ ë³µê·€
        const checkPopup = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkPopup);
            resetSearch(); // ì§€ë„ ì´ˆê¸°í™”
            updatePatrolDisplay(); // ì˜ˆì • ëª©ë¡ ê°±ì‹ 
          }
        }, 500);
      }
    };
    list.appendChild(li);
  });
}


function initMap(){
  map = L.map('map').setView([37.3857,126.6586], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  markerCluster = L.markerClusterGroup();
  map.addLayer(markerCluster);

  gpxLayerGroup = L.layerGroup().addTo(map);

  // âœ… routes/ ì˜ GPX íŒŒì¼ë“¤ì„ ì§€ë„ì— íŠ¸ë™ìœ¼ë¡œ í‘œì‹œ
  ROUTE_GPX_FILES.forEach((url) => {
    new L.GPX(url, {
      async: true,
      polyline_options: {
        color: "#ff0000",
        weight: 4,
        opacity: 0.85
      },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    })
    .on("loaded", function (e) {
      // map.fitBounds(e.target.getBounds()); // í•„ìš” ì‹œ í™œì„±í™”
    })
    .on("error", function () {
      console.warn("GPX ë¡œë“œ ì‹¤íŒ¨:", url);
    })
    .addTo(gpxLayerGroup);
  });

  map.on("click", e=>{
    if(searchMode) return;
    lastClickedCoord = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
    document.getElementById("clickedCoords").innerText = `ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;
    if(window.lastClickMarker) markerCluster.removeLayer(window.lastClickMarker);
    window.lastClickMarker = L.marker(e.latlng, { icon: L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/orange-dot.png", iconSize:[32,32]}) }).addTo(markerCluster);
  });
}

function clearMarkers(){ markerCluster.clearLayers(); markers=[]; }

function addMarker(id, pos, color){
  const defaultIcon = L.icon({
    iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
    iconSize: [32, 32]
  });
  const clickedIcon = L.icon({
    iconUrl: `https://maps.google.com/mapfiles/ms/icons/red-dot.png`,
    iconSize: [32, 32]
  });

  const m = L.marker([pos.lat, pos.lng], { icon: defaultIcon });
  m.bindPopup(`<strong>${lampData[id].ê³ ìœ ì´ë¦„}</strong><br/><b>ë¶„ë¥˜:</b> ${lampData[id].ë¶„ë¥˜}<br/><b>ì „í™”ë²ˆí˜¸:</b> ${lampData[id].ì „í™”ë²ˆí˜¸}<br/><b>ì£¼ì†Œ:</b> ${lampData[id].ì£¼ì†Œ}<br/><b>íŠ¹ì´ì‚¬í•­:</b> ${lampData[id].íŠ¹ì´ì‚¬í•­}`);

  m.on("click", () => {
    // í´ë¦­ëœ ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½
    m.setIcon(clickedIcon);

    // ì´ì „ í´ë¦­ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µì›
    if (lastClickedMarker && lastClickedMarker !== m) {
      lastClickedMarker.setIcon(defaultIcon);
    }
    lastClickedMarker = m;

    // í´ë¦­ ì¢Œí‘œ ì—…ë°ì´íŠ¸
    lastClickedCoord = lampData[id].ì¢Œí‘œ;
    document.getElementById("clickedCoords").innerText = `ğŸ“ ì„ íƒ: ${lastClickedCoord}`;
  });

  markerCluster.addLayer(m);
  markers.push(m);
}

// í´ë¦­ ì¢Œí‘œ â†’ ì¹´ì¹´ì˜¤ë§µ URL ë³µì‚¬
document.getElementById("copyRouteBtn").addEventListener("click",()=>{
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”."); return; }
  const [lat,lng]=lastClickedCoord.split(",");
  const kakaoWebUrl=`https://map.kakao.com/link/to/${encodeURIComponent("ì„ íƒìœ„ì¹˜")},${lat},${lng}`;
  navigator.clipboard.writeText(kakaoWebUrl)
    .then(()=>alert("âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë³´ë‚´ë©´ í•´ë‹¹ ìœ„ì¹˜ ê¸¸ì°¾ê¸° ê°€ëŠ¥"))
    .catch(()=>alert("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨"));
});

function normalizeSimple(str){ return (str||"").toLowerCase().replace(/[\s\-\_\.,\/\(\)\[\]#]/g,""); }

function searchAndShow() {
  const kw = document.getElementById("keyword").value.trim();
  if (!kw) { alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥í•˜ì„¸ìš”."); return; }
  searchMode = true;
  clearMarkers();

  const kwNormalized = normalizeSimple(kw);
  if(kwNormalized.length<2){ alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥"); return; }
  const kwRegex = new RegExp(kwNormalized.split("").join(".*"), "i");

  const res = Object.keys(lampData).filter(id=>{
    const d = lampData[id];
    const fields = [d.ê³ ìœ ì´ë¦„,d.ì „í™”ë²ˆí˜¸,d.ì£¼ì†Œ,d.ë¶„ë¥˜,d.íŠ¹ì´ì‚¬í•­];
    return fields.some(f=>kwRegex.test(normalizeSimple(f)));
  }).map(id=>({id,pos:parseCoords(lampData[id].ì¢Œí‘œ)}));

  if(res.length===0){ alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"); return; }
  const bounds = L.latLngBounds();
  res.forEach(r=>{ addMarker(r.id,r.pos,"blue"); bounds.extend([r.pos.lat,r.pos.lng]); });
  map.fitBounds(bounds);
}

function resetSearch(){ searchMode=false; clearMarkers(); document.getElementById("keyword").value=""; lastClickedCoord=""; document.getElementById("clickedCoords").innerText="ğŸ“"; }

function navigateToPatrol() {
  if (!lastClickedCoord) {
    alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }
  const [destLat, destLng] = lastClickedCoord.split(",");

  // ì§€ë„ í‘œì‹œ URL (ì•± ì„¤ì¹˜ ì‹œ ì¹´ì¹´ì˜¤ë§µ ì•±ìœ¼ë¡œ, ë¯¸ì„¤ì¹˜ ì‹œ ì›¹ìœ¼ë¡œ ì—´ë¦¼)
  const mapUrl = `https://map.kakao.com/link/map/ì„ íƒìœ„ì¹˜,${destLat},${destLng}`;

  if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
    // ëª¨ë°”ì¼ í™˜ê²½ â†’ ì§€ë„ í‘œì‹œ URL ìš°ì„  ì—´ê¸°
    window.location.href = mapUrl;
  } else {
    // PC í™˜ê²½ â†’ ìƒˆ íƒ­ì—ì„œ ì§€ë„ í‘œì‹œ
    window.open(mapUrl, "_blank");
  }
}




function completePatrol(){
  if(!activePatrol){ return; }

  completedPatrols.add(activePatrol.key);
  localStorage.setItem(
    "patrol_" + new Date().toISOString().slice(0,10),
    JSON.stringify([...completedPatrols])
  );

  const patrolId = activePatrol.task.id;
  const data = lampData[patrolId];
  const now = new Date();

  // âœ… ì˜¤ëŠ˜ 00:01 ì´í›„ì¸ì§€ ê²€ì‚¬
  const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 1, 0);
  if(now < todayMidnight){ 
    // ì•„ì§ ì˜¤ëŠ˜ 00:01 ì „ì´ë©´ ê¸°ë¡ ì•ˆ í•¨
    return; 
  }

  const patrolTime = now.toLocaleString("ko-KR");
  const logLine = `ì•„ì´ë””: ${patrolId}, ìˆœì°°ì‹œê°„: ${patrolTime}, ê³ ìœ ì´ë¦„: ${data?.ê³ ìœ ì´ë¦„||"ì´ë¦„ ì—†ìŒ"}, ì£¼ì†Œ: ${data?.ì£¼ì†Œ||"ì£¼ì†Œ ì—†ìŒ"}\n`;

  const todayKey = "patrol_text_log_" + now.toISOString().slice(0,10);
  const existingLog = localStorage.getItem(todayKey) || "";
  const newLog = existingLog + logLine;
  localStorage.setItem(todayKey, newLog);

  // ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ
  const today = new Date();
  const keysToDelete = [];
  for (let i = 0; i < localStorage.length; i++){
    const key = localStorage.key(i);
    if (key.startsWith("patrol_text_log_")){
      const dateStr = key.replace("patrol_text_log_","");
      const logDate = new Date(dateStr);
      if ((today - logDate) / (1000*60*60*24) > 1){
        keysToDelete.push(key);
      }
    }
  }
  keysToDelete.forEach(k => localStorage.removeItem(k));

  activePatrol = null;
  showUpcomingPatrols();
}

// ğŸ“‹ ë¡œê·¸ ë·°ì–´ ON/OFF
function toggleLogViewer(){
  const logContent=document.getElementById("logContent");
  if(logContent.style.display==="none" || logContent.style.display===""){
    const todayKey="patrol_text_log_" + new Date().toISOString().slice(0,10);
    const allLogs = localStorage.getItem(todayKey) || "";

    // âœ… ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ë§Œ í•„í„°ë§
    const todayDateStr = new Date().toLocaleDateString("ko-KR"); 
    const filteredLogs = allLogs
      .split("\n")
      .filter(line => line.includes(todayDateStr))
      .join("\n");

    logContent.value = filteredLogs;
    logContent.style.display="block";
  } else {
    logContent.style.display="none";
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  // ì²˜ìŒì—ëŠ” textarea ë‹«í˜ ìƒíƒœ ìœ ì§€
  document.getElementById("upcomingPanel").addEventListener("click",e=>{
    if(e.target.tagName.toLowerCase()!=="li") e.currentTarget.classList.toggle("hidden");
  });
  initMap(); 
  updatePatrolDisplay();
});
</script>
</body>
</html>







