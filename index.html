<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>íŠ¹ì • poi ê¸°ë°˜ ì¶œë™/ìˆœì°° ì‹œìŠ¤í…œ</title>
<meta http-equiv="refresh" content="300">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
h3 { text-align: center; background: #007bff; color: white; margin: 0; padding: 10px; }
#panel { padding: 10px; text-align: center; max-width: 400px; margin: 10px auto; }
#panel input, #panel button { width: 90%; max-width: 350px; padding: 10px; margin: 5px auto; font-size: 16px; display: block; border: 1px solid #ccc; border-radius: 5px; }
#map { height: 70vh; width: 100%; }
#clickedCoords { width: 90%; max-width: 350px; padding: 8px; margin: 5px auto; border: 1px solid #007bff; background: #eef6ff; font-size: 14px; border-radius: 5px; text-align: center; }
#copyBtn { width: 90%; max-width: 350px; background: #ff9800; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
#completeBtn { background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 90%; max-width: 350px; margin: 10px auto; display: block; }
#navigateBtn { background:#007bff; color:white; border:none; padding:10px; border-radius:5px; font-size:16px; cursor:pointer; width:90%; max-width:350px; margin:10px auto; display:block; }
#upcomingPanel { position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.95); border: 1px solid #007bff; border-radius: 5px; padding: 10px; font-size: 14px; z-index: 9999; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease; cursor: pointer; }
#upcomingPanel h4 { margin: 0 0 5px; font-size: 16px; color: #007bff; }
#upcomingList { list-style: none; padding: 0; margin: 0; }
#upcomingList li { padding: 5px 8px; border-bottom: 1px solid #ddd; cursor: pointer; border-radius: 3px; user-select: none; }
#upcomingList li:hover { background: #eef6ff; }
#upcomingPanel.hidden { width: 50px; height: 40px; padding: 5px; overflow: hidden; cursor: pointer; }
#upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display: none; }
#upcomingPanel.hidden::after { content: "â°"; position: absolute; top: 10px; left: 15px; font-size: 20px; color: #007bff; }
</style>

<script src="lampData.js"></script>
<script src="patrolSchedule.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=&libraries=places"></script>
</head>
<body>
<h3>ğŸš“ í•¨ê»˜ ë§Œë“œëŠ” ìˆœì°°/ì¶œë™ poi(ì‹ ì •2)</h3>

<div id="panel">
  <label>ìˆœì°°ì¹´í…Œê³ ë¦¬:</label>
  <ul id="categoryList" style="list-style:none; padding:0; margin:5px auto; max-width:200px; display:flex; justify-content:center; gap:10px;">
    <li data-cat="ì•ˆì „ì¡°ì¹˜" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">ì•ˆì „ì¡°ì¹˜</li>
    <li data-cat="?" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">?</li>
  </ul>

  <input type="text" id="keyword" placeholder="í‚¤ì›Œë“œì…ë ¥(ì˜ˆ:ì•ˆì–‘ì²œ 9-2, ê³µì¤‘ì „í™”, ì•ˆì „ì¡°ì¹˜ ë“±)" />
  <div style="display:flex; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
    <button onclick="searchAndShow()" style="flex:1; padding:6px 8px; font-size:14px; border:1px solid #007bff; background:#007bff; color:white; border-radius:5px; cursor:pointer;">ê²€ìƒ‰</button>
    <button onclick="resetSearch()" style="flex:1; padding:6px 8px; font-size:14px; border:1px solid #6c757d; background:#6c757d; color:white; border-radius:5px; cursor:pointer;">ì´ˆê¸°í™”</button>
  </div>

  <div style="display:flex; align-items:center; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
    <div id="clickedCoords" style="flex:1; padding:8px; border:1px solid #007bff; background:#eef6ff; font-size:14px; border-radius:5px; text-align:center;">ğŸ“</div>
    <button id="copyRouteBtn" style="padding:6px 8px; font-size:12px; background:#ff9800; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ“‹ ìœ„ì¹˜ url ë³µì‚¬</button>
  </div>

  <div style="display:flex; justify-content:center; gap:10px; max-width:350px; margin:10px auto;">
    <button id="completeBtn" onclick="completePatrol()" style="flex:1; padding:6px; font-size:14px; border-radius:5px; background:#28a745; color:white; border:none; cursor:pointer;">âœ… ìˆœì°° ì™„ë£Œ</button>
    <button id="navigateBtn" onclick="navigateToPatrol()" style="flex:1; padding:6px; font-size:14px; border-radius:5px; background:#007bff; color:white; border:none; cursor:pointer;">ğŸ“ ê¸¸ì°¾ê¸°</button>
  </div>
</div>

<div id="upcomingPanel">
  <h4>â° ìˆœì°° í›„ ìˆœì°°ì™„ë£Œ ìš”ë§</h4>
  <ul id="upcomingList"></ul>
</div>

<div id="map"></div>

<script>
let activeCategories = ["ì•ˆì „ì¡°ì¹˜"];
let activePatrol = null;
let lastClickedCoord = "";
let map, markers = [], infoWindow;
let searchMode = false;
let activeMarker = null; // ì„ íƒëœ ê²€ìƒ‰ ë§ˆì»¤
let completedPatrols = new Set(JSON.parse(localStorage.getItem("patrol_" + new Date().toISOString().slice(0,10))||"[]"));

function setActiveCategories(selectedCategories) {
  activeCategories = selectedCategories.filter(cat => patrolSchedules.hasOwnProperty(cat));
  updatePatrolDisplay();
}

document.querySelectorAll("#categoryList li").forEach(li => {
  li.addEventListener("click", () => {
    const cat = li.getAttribute("data-cat");
    if (activeCategories.includes(cat)) {
      activeCategories = activeCategories.filter(c => c !== cat);
      li.style.background = "white"; li.style.color = "#007bff"; li.style.border = "1px solid #007bff";
    } else {
      activeCategories.push(cat);
      li.style.background = "#007bff"; li.style.color = "white"; li.style.border = "1px solid #007bff";
    }
    updatePatrolDisplay();
  });
});

function getActivePatrolSchedule() {
  let combined = [];
  activeCategories.forEach(cat => {
    if (patrolSchedules[cat]) combined = combined.concat(patrolSchedules[cat]);
  });
  return combined;
}

function updatePatrolDisplay(){ showUpcomingPatrols(); }

function isWithinDateRange(dateStr,startDateStr,endDateStr){ const d=new Date(dateStr); return d>=new Date(startDateStr)&&d<=new Date(endDateStr); }
function isDayAllowed(date,days){return days.includes(date.getDay());}
function parseCoords(s){const[a,b]=s.split(",").map(Number);return{lat:a,lng:b};}
function pad(n){ return n.toString().padStart(2,"0"); }
function isSequenceMatch(text, keyword){ let idx=0; for(const ch of keyword){ idx=text.indexOf(ch, idx); if(idx === -1) return false; idx++; } return true; }

function showUpcomingPatrols(){
  const now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const list=document.getElementById("upcomingList");
  list.innerHTML="";
  const upcoming=[];
  const patrolSchedule = getActivePatrolSchedule();

  patrolSchedule.forEach(task=>{
    if(!isWithinDateRange(now.toISOString().slice(0,10),task.startDate,task.endDate)) return;
    if(!isDayAllowed(now,task.daysOfWeek)) return;
    task.timeRanges.forEach(r=>{
      const [sH,sM]=r.start.split(":").map(Number);
      const [eH,eM]=r.end.split(":").map(Number);
      const startM=sH*60+sM-30;
      const endM=eH*60+eM+30;
      const isOngoing=nowM>=sH*60+sM && nowM<=eH*60+eM;
      const isInWindow=nowM>=startM && nowM<=endM;
      const patrolKey=`${task.id}|${r.start}~${r.end}`;
      if(isInWindow && !completedPatrols.has(patrolKey)) upcoming.push({task,hour:sH,minute:sM,endHour:eH,endMinute:eM,key:patrolKey,isInTime:isOngoing});
    });
  });

  if(upcoming.length===0){ list.innerHTML="<li>âœ… ì˜ˆì • ì—†ìŒ</li>"; return; }
  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item=>{
    const li=document.createElement("li");
    li.style.color=item.isInTime?"blue":"black";
    li.textContent=`${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;
    li.onclick=()=>{ 
      activePatrol={task:item.task,hour:item.hour,minute:item.minute,key:item.key};
      const id=item.task.id;
      if(!lampData[id]){ alert("ì¢Œí‘œ ì •ë³´ ì—†ìŒ"); return; }
      const pos=parseCoords(lampData[id].ì¢Œí‘œ);
      lastClickedCoord = `${pos.lat},${pos.lng}`;
      document.getElementById("clickedCoords").innerText = `ğŸ“ ${lampData[id].ê³ ìœ ì´ë¦„}`;
      window.open(`https://map.kakao.com/link/to/${encodeURIComponent(item.task.id)},${pos.lat},${pos.lng}`,"_blank");
    };
    list.appendChild(li);
  });
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {center:{lat:37.3857,lng:126.6586}, zoom:15});
  infoWindow = new google.maps.InfoWindow();

  map.addListener("click", e => {
    if(searchMode) return;
    lastClickedCoord = `${e.latLng.lat().toFixed(6)},${e.latLng.lng().toFixed(6)}`;
    document.getElementById("clickedCoords").innerText = `ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;
    if(window.lastClickMarker) window.lastClickMarker.setMap(null);
    window.lastClickMarker = new google.maps.Marker({position:e.latLng,map:map,icon:"http://maps.google.com/mapfiles/ms/icons/orange-dot.png",title:"ì„ íƒí•œ ìœ„ì¹˜"});
  });
}

function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; activeMarker=null; }

function addMarker(id,pos,color){
  const m=new google.maps.Marker({position:pos,map:map,label:id,icon:{url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`}});
  m.addListener("click",()=>{
    const data=lampData[id];
    infoWindow.setContent(`<div style="min-width:150px;"><strong>${data.ê³ ìœ ì´ë¦„}</strong><br/><b>ë¶„ë¥˜:</b>${data.ë¶„ë¥˜}<br/><b>ì „í™”ë²ˆí˜¸:</b>${data.ì „í™”ë²ˆí˜¸}<br/><b>ì£¼ì†Œ:</b>${data.ì£¼ì†Œ}<br/><b>íŠ¹ì´ì‚¬í•­:</b>${data.íŠ¹ì´ì‚¬í•­}</div>`);
    infoWindow.open(map,m);
    if(activeMarker && activeMarker !== m) activeMarker.setIcon({url:`http://maps.google.com/mapfiles/ms/icons/blue-dot.png`});
    activeMarker = m;
    m.setIcon({url:`http://maps.google.com/mapfiles/ms/icons/red-dot.png`});
  });
  markers.push(m);
}

document.getElementById("copyRouteBtn").addEventListener("click",()=>{
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì»¤ ì„ íƒ"); return; }
  openKakaoMapRoute(lastClickedCoord,"ì„ íƒí•œìœ„ì¹˜");
});

function searchAndShow(){
  const kw=document.getElementById("keyword").value.trim();
  if(!kw){ alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥"); return; }
  searchMode=true; clearMarkers();
  const kwLower = kw.toLowerCase().replace(/\s+/g,"");
  if(kwLower.length<2){ alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ"); return; }
  const normalizeSimple = str => (str||"").toLowerCase().replace(/[\s\-\_\.,\/\(\)\[\]#]/g,"");
  const kwNormalized = normalizeSimple(kwLower);
  const res = Object.keys(lampData).filter(id=>{
    const d=lampData[id];
    const fields=[d.ê³ ìœ ì´ë¦„,d.ì „í™”ë²ˆí˜¸,d.ì£¼ì†Œ,d.ë¶„ë¥˜,d.íŠ¹ì´ì‚¬í•­];
    return fields.some(field=>{
      const text = (field||"").toLowerCase();
      const textNorm = normalizeSimple(text);
      return text.includes(kwLower)||textNorm.includes(kwNormalized)||isSequenceMatch(text,kwLower)||isSequenceMatch(textNorm,kwNormalized);
    });
  }).map(id=>({id,pos:parseCoords(lampData[id].ì¢Œí‘œ)}));

  if(res.length===0){ alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"); return; }
  const bounds = new google.maps.LatLngBounds();
  res.forEach(r=>{ addMarker(r.id,r.pos,"blue"); bounds.extend(r.pos); });
  map.fitBounds(bounds);
}

function resetSearch(){
  searchMode=false; clearMarkers();
  document.getElementById("keyword").value="";
  lastClickedCoord=""; document.getElementById("clickedCoords").innerText="ğŸ“";
  if(window.lastClickMarker){ window.lastClickMarker.setMap(null); window.lastClickMarker=null; }
  map.setCenter({lat:37.3857,lng:126.6586}); map.setZoom(15);
}

function navigateToPatrol(){
  let destLat,destLng,destName;
  if(activeMarker){
    const id=activeMarker.getLabel();
    const data=lampData[id];
    [destLat,destLng]=data.ì¢Œí‘œ.split(",");
    destName=data.ê³ ìœ ì´ë¦„;
  } else if(lastClickedCoord){
    [destLat,destLng]=lastClickedCoord.split(",");
    destName="ì„ íƒí•œìœ„ì¹˜";
  } else { alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì»¤ ì„ íƒ"); return; }
  openKakaoMapRoute(`${destLat},${destLng}`,destName);
}

function openKakaoMapRoute(coord,name){
  const [destLat,destLng]=coord.split(",");
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const startLat=pos.coords.latitude.toFixed(6);
      const startLng=pos.coords.longitude.toFixed(6);
      const appUrl=`kakaomap://route?sp=${startLat},${startLng}&ep=${destLat},${destLng}&by=CAR`;
      const webUrl=`https://map.kakao.com/link/to/${encodeURIComponent(name)},${destLat},${destLng}`;
      if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
        window.location.href=appUrl; setTimeout(()=>window.open(webUrl,"_blank"),1500);
      } else window.open(webUrl,"_blank");
    },()=>{
      alert("í˜„ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨, ì›¹ìœ¼ë¡œ ì—°ê²°");
      window.open(`https://map.kakao.com/link/to/${encodeURIComponent(name)},${destLat},${destLng}`,"_blank");
    });
  } else window.open(`https://map.kakao.com/link/to/${encodeURIComponent(name)},${destLat},${destLng}`,"_blank");
}

function completePatrol(){
  if(!activePatrol){ alert("ğŸš« ì§„í–‰ ì¤‘ì¸ ìˆœì°°ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  completedPatrols.add(activePatrol.key);
  localStorage.setItem("patrol_" + new Date().toISOString().slice(0,10),JSON.stringify([...completedPatrols]));

  const patrolId=activePatrol.task.id;
  const data=lampData[patrolId];
  const patrolTime=new Date().toLocaleString("ko-KR",{hour12:false});
  alert(`âœ… ${patrolId} ìˆœì°° ì™„ë£Œ!\nìœ„ì¹˜: ${data?data.ê³ ìœ ì´ë¦„:"ì •ë³´ ì—†ìŒ"}\nì‹œê°„: ${patrolTime}`);
  showUpcomingPatrols();
  activePatrol=null;
}

initMap();
showUpcomingPatrols();

// â° íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°
const panel=document.getElementById("upcomingPanel");
panel.addEventListener("click",()=>{ panel.classList.toggle("hidden"); });

</script>
</body>
</html>
