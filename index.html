<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>íŠ¹ì • poi ê¸°ë°˜ ì¶œë™/ìˆœì°° ì‹œìŠ¤í…œ</title>
  <meta http-equiv="refresh" content="300">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    h3 { text-align: center; background: #007bff; color: white; margin: 0; padding: 10px; }
    #panel { padding: 10px; text-align: center; max-width: 400px; margin: 10px auto; }
    #panel input, #panel button {
      width: 90%; max-width: 350px; padding: 10px; margin: 5px auto;
      font-size: 16px; display: block; border: 1px solid #ccc; border-radius: 5px;
    }
    #map { height: 70vh; width: 100%; }
    #clickedCoords {
      width: 90%; max-width: 350px; padding: 8px; margin: 5px auto;
      border: 1px solid #007bff; background: #eef6ff; font-size: 14px;
      border-radius: 5px; text-align: center;
    }
    #copyBtn {
      width: 90%; max-width: 350px; background: #ff9800; color: white;
      border: none; padding: 8px; border-radius: 5px; cursor: pointer;
    }
    #completeBtn {
      background: #28a745; color: white; border: none;
      padding: 10px; border-radius: 5px; font-size: 16px;
      cursor: pointer; width: 90%; max-width: 350px; margin: 10px auto; display: block;
    }
    #navigateBtn {
      background:#007bff; color:white; border:none;
      padding:10px; border-radius:5px; font-size:16px;
      cursor:pointer; width:90%; max-width:350px; margin:10px auto; display:block;
    }
    #upcomingPanel {
      position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh;
      overflow-y: auto; background: rgba(255,255,255,0.95);
      border: 1px solid #007bff; border-radius: 5px; padding: 10px;
      font-size: 14px; z-index: 9999; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease; cursor: pointer;
    }
    #upcomingPanel h4 { margin: 0 0 5px; font-size: 16px; color: #007bff; }
    #upcomingList { list-style: none; padding: 0; margin: 0; }
    #upcomingList li { padding: 5px 8px; border-bottom: 1px solid #ddd; cursor: pointer; border-radius: 3px; user-select: none; }
    #upcomingList li:hover { background: #eef6ff; }
    #upcomingPanel.hidden { width: 50px; height: 40px; padding: 5px; overflow: hidden; cursor: pointer; }
    #upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display: none; }
    #upcomingPanel.hidden::after { content: "â°"; position: absolute; top: 10px; left: 15px; font-size: 20px; color: #007bff; }
  </style>
 
  <script src="lampData.js"></script>
  <script src="patrolSchedule.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=&libraries=places"></script>
</head>
<body>
<h3>ğŸš“ í•¨ê»˜ ë§Œë“œëŠ” ìˆœì°°/ì¶œë™ poi(ì‹ ì •2)</h3>

<div id="panel">
  <!-- âœ… ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ëŒ€ì‹  ì•„ë˜ì²˜ëŸ¼ ë³€ê²½ -->
  <label>ìˆœì°°ì¹´í…Œê³ ë¦¬:</label>
  <ul id="categoryList" style="list-style:none; padding:0; margin:5px auto; max-width:200px; display:flex; justify-content:center; gap:10px;">
    <li data-cat="ì•ˆì „ì¡°ì¹˜" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">ì•ˆì „ì¡°ì¹˜</li>
    <li data-cat="?" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">?</li>
  </ul>
  
  <input type="text" id="keyword" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: L0, L003, ë²”ì, ë²” í”¼, ì „í™”ë²ˆí˜¸ ì¼ë¶€)" />
  <div style="display:flex; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
  <button onclick="searchAndShow()" 
    style="flex:1; padding:6px 8px; font-size:14px; border:1px solid #007bff; background:#007bff; color:white; border-radius:5px; cursor:pointer;">
    ê²€ìƒ‰
  </button>
  <button onclick="resetSearch()" 
    style="flex:1; padding:6px 8px; font-size:14px; border:1px solid #6c757d; background:#6c757d; color:white; border-radius:5px; cursor:pointer;">
    ì´ˆê¸°í™”
  </button>
  </div>
  <div style="display:flex; align-items:center; justify-content:center; gap:5px; max-width:350px; margin:5px auto;">
  <div id="clickedCoords" style="flex:1; padding:8px; border:1px solid #007bff; background:#eef6ff; font-size:14px; border-radius:5px; text-align:center;">
    ğŸ“ 
  </div>
  <button id="copyRouteBtn" style="padding:6px 8px; font-size:12px; background:#ff9800; color:white; border:none; border-radius:5px; cursor:pointer;">
    ğŸ“‹ ìœ„ì¹˜ url ë³µì‚¬
  </button>
  </div>
  <div style="display:flex; justify-content:center; gap:10px; max-width:350px; margin:10px auto;">
  <button id="completeBtn" onclick="completePatrol()" 
          style="flex:1; padding:6px; font-size:14px; border-radius:5px; background:#28a745; color:white; border:none; cursor:pointer;">
    âœ… ìˆœì°° ì™„ë£Œ
  </button>
  <button id="navigateBtn" onclick="navigateToPatrol()" 
          style="flex:1; padding:6px; font-size:14px; border-radius:5px; background:#007bff; color:white; border:none; cursor:pointer;">
    ğŸ“ ê¸¸ì°¾ê¸°
  </button>
  </div>
  
</div>

<div id="upcomingPanel">
  <h4>â° ìˆœì°° í›„ ìˆœì°°ì™„ë£Œ ìš”ë§</h4>
  <ul id="upcomingList"></ul>
</div>

<div id="map"></div>

<script>
 
// â‘¡ í˜„ì¬ í™œì„±í™”í•  ì¹´í…Œê³ ë¦¬ (ì´ˆê¸°ê°’)
//let activeCategories = ["ì•ˆì „ì¡°ì¹˜", "íŠ¹ë³„ìˆœì°°"];
  let activeCategories = ["ì•ˆì „ì¡°ì¹˜"];

// â‘¢ ì¹´í…Œê³ ë¦¬ ë³€ê²½ í•¨ìˆ˜
  function setActiveCategories(selectedCategories) {
  activeCategories = selectedCategories.filter(cat => patrolSchedules.hasOwnProperty(cat));
  console.log("í˜„ì¬ í™œì„±í™”ëœ ìˆœì°° ì¹´í…Œê³ ë¦¬:", activeCategories);
  updatePatrolDisplay();
}


// ğŸ—‚ 4. í˜„ì¬ í™œì„± ìŠ¤ì¼€ì¤„ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´)
function getActivePatrolSchedule() {
  let combined = [];
  activeCategories.forEach(cat => {
    if (patrolSchedules[cat]) {
      combined = combined.concat(patrolSchedules[cat]);
    }
  });
  return combined;
}

// â‘¤ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì—°ê²°
//  document.getElementById("categorySelect").addEventListener("change", function() {
//  const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
//  setActiveCategories(selectedOptions);
//});

// â‘¤ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì—°ê²°
document.querySelectorAll("#categoryList li").forEach(li => {
  li.addEventListener("click", () => {
    const cat = li.getAttribute("data-cat");
    if (activeCategories.includes(cat)) {
      // ì´ë¯¸ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë©´ í•´ì œ (ë°°ê²½ìƒ‰ ë°”ê¾¸ê¸°)
      activeCategories = activeCategories.filter(c => c !== cat);
      li.style.background = "white";
      li.style.color = "#007bff";
      li.style.border = "1px solid #007bff";
    } else {
      // ì„ íƒ ì•ˆëœ ì¹´í…Œê³ ë¦¬ë©´ ì¶”ê°€
      activeCategories.push(cat);
      li.style.background = "#007bff";
      li.style.color = "white";
      li.style.border = "1px solid #007bff";
    }
    console.log("í˜„ì¬ í™œì„±í™”ëœ ìˆœì°° ì¹´í…Œê³ ë¦¬:", activeCategories);
    updatePatrolDisplay();
  });
});


// ğŸ—‚ 6. í™”ë©´ ê°±ì‹  í•¨ìˆ˜
function updatePatrolDisplay() {
  // í•„ìš”í•˜ë‹¤ë©´ ì§€ë„ ë§ˆì»¤ë¥¼ ê°±ì‹ í•˜ë„ë¡ í™•ì¥ ê°€ëŠ¥
  showUpcomingPatrols();
}

 
/* âœ… ë‚ ì§œ/ì‹œê°„ ìœ í‹¸ í•¨ìˆ˜ */
function isWithinDateRange(dateStr,startDateStr,endDateStr){ const d=new Date(dateStr); return d>=new Date(startDateStr)&&d<=new Date(endDateStr); }
function isDayAllowed(date,days){return days.includes(date.getDay());}
function parseCoords(s){const[a,b]=s.split(",").map(Number);return{lat:a,lng:b};}
function pad(n){ return n.toString().padStart(2,"0"); }
function normalizeText(str){ return (str||"").toLowerCase().replace(/[\s\-\_\.,]/g,""); }
function isSequenceMatch(text, keyword){ let idx=0; for(const ch of keyword){ idx=text.indexOf(ch, idx); if(idx === -1) return false; idx++; } return true; }

/* âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ */
function getTodayKey(){ return "patrol_" + new Date().toISOString().slice(0,10); }
function loadCompletedPatrols(){ const data=localStorage.getItem(getTodayKey()); return data?new Set(JSON.parse(data)):new Set(); }
function saveCompletedPatrols(){ localStorage.setItem(getTodayKey(), JSON.stringify([...completedPatrols])); }
let completedPatrols = loadCompletedPatrols();

/* âœ… ìƒíƒœ ë³€ìˆ˜ */
let activePatrol = null;
let lastClickedCoord = "";
let map, markers = [], infoWindow;
let searchMode = false;   // ğŸ”¹ ê²€ìƒ‰ ëª¨ë“œ ì—¬ë¶€

/* âœ… ìˆœì°° ë¦¬ìŠ¤íŠ¸ í‘œì‹œ */
function showUpcomingPatrols(){
  const now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const list=document.getElementById("upcomingList");
  list.innerHTML="";
  const upcoming=[];

  const patrolSchedule = getActivePatrolSchedule();

  patrolSchedule.forEach(task=>{
    if(!isWithinDateRange(now.toISOString().slice(0,10),task.startDate,task.endDate)) return;
    if(!isDayAllowed(now,task.daysOfWeek)) return;

    task.timeRanges.forEach(r=>{
      const [sH,sM]=r.start.split(":").map(Number);
      const [eH,eM]=r.end.split(":").map(Number);
      const startM=sH*60+sM-30;
      const endM=eH*60+eM+30;
      const isOngoing=nowM>=sH*60+sM && nowM<=eH*60+eM;
      const isInWindow=nowM>=startM && nowM<=endM;
      const patrolKey=`${task.id}|${r.start}~${r.end}`;

      if(isInWindow && !completedPatrols.has(patrolKey)){
        upcoming.push({task,hour:sH,minute:sM,endHour:eH,endMinute:eM,key:patrolKey,isInTime:isOngoing});
      }
    });
  });

  if(upcoming.length===0){ list.innerHTML="<li>âœ… ì˜ˆì • ì—†ìŒ</li>"; return; }

  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item=>{
    const li=document.createElement("li");
    li.style.color=item.isInTime?"blue":"black";
    li.textContent=`${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;
    li.onclick=()=>{
      activePatrol={task:item.task,hour:item.hour,minute:item.minute,key:item.key};
      const id = item.task.id;
      if(!lampData[id]){ alert("í•´ë‹¹ IDì˜ ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const pos=parseCoords(lampData[id].ì¢Œí‘œ);
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${pos.lat},${pos.lng}`,"_blank");
    };
    list.appendChild(li);
  });
}

/* ------------------------ âœ… ì§€ë„ ê¸°ëŠ¥ ------------------------ */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 37.3857, lng: 126.6586 },
    zoom: 15
  });
  infoWindow = new google.maps.InfoWindow();

  map.addListener("click", e => {
    if (searchMode) return; // ğŸ”¹ ê²€ìƒ‰ ëª¨ë“œì¼ ë•ŒëŠ” í´ë¦­ ë§ˆì»¤ ìƒì„± ì•ˆ í•¨

    // í´ë¦­ ì¢Œí‘œ ì €ì¥
    lastClickedCoord = `${e.latLng.lat().toFixed(6)},${e.latLng.lng().toFixed(6)}`;
    document.getElementById("clickedCoords").innerText = `ğŸ“ í´ë¦­ ì¢Œí‘œ: ${lastClickedCoord}`;

    // ê¸°ì¡´ í´ë¦­ ë§ˆì»¤ ì œê±°
    if (window.lastClickMarker) {
      window.lastClickMarker.setMap(null);
    }

    // í´ë¦­í•œ ìœ„ì¹˜ì— ìƒˆ ë§ˆì»¤ ìƒì„±
    window.lastClickMarker = new google.maps.Marker({
      position: e.latLng,
      map: map,
      icon: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      title: "ì„ íƒí•œ ìœ„ì¹˜"
    });
  });
}



//function copyCoords(){ if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”."); return; } navigator.clipboard.writeText(lastClickedCoord).then(()=>alert("âœ… ë³µì‚¬ë¨: "+lastClickedCoord)); }
function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }
function addMarker(id,pos,color){
  const m=new google.maps.Marker({position:pos,map,label:id,icon:{url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`}});
  m.addListener("click", () => {
    const data = lampData[id];
    infoWindow.setContent(`
      <div style="min-width:150px;">
        <strong>${data.ê³ ìœ ì´ë¦„}</strong><br/>
        <b>ë¶„ë¥˜:</b> ${data.ë¶„ë¥˜}<br/>
        <b>ì „í™”ë²ˆí˜¸:</b> ${data.ì „í™”ë²ˆí˜¸}<br/>
        <b>ì£¼ì†Œ:</b> ${data.ì£¼ì†Œ}<br/>
        <b>íŠ¹ì´ì‚¬í•­:</b> ${data.íŠ¹ì´ì‚¬í•­}
      </div>
  `  );
    infoWindow.open(map, m);
  });
  m.addListener("dblclick",()=>{const c=lampData[id].ì¢Œí‘œ.split(",");window.open(`https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`,"_blank");});
  markers.push(m);
}
/* ------------------- êµ¬ê¸€ ê¸¸ì°¾ê¸° URL ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ------------------- */
document.getElementById("copyRouteBtn").addEventListener("click", () => {
  if (!lastClickedCoord) {
    alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const [lat, lng] = lastClickedCoord.split(",");
  const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

  navigator.clipboard.writeText(gmapsUrl).then(() => {
    alert(`âœ… Google Maps ê¸¸ì°¾ê¸° URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n${gmapsUrl}\n\nì´ì œ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
  }).catch(err => {
    alert("âš ï¸ URL ë³µì‚¬ ì‹¤íŒ¨: " + err);
  });
});

/* âœ… ê²€ìƒ‰ */
function searchAndShow() {
  const kw = document.getElementById("keyword").value.trim();
  if (!kw) {
    alert("âš ï¸ í‚¤ì›Œë“œ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  searchMode = true; // ğŸ”¹ ê²€ìƒ‰ ëª¨ë“œ í™œì„±í™”
  clearMarkers();

  const kwLower = kw.toLowerCase().replace(/\s+/g, "");
  if (kwLower.length < 2) {
    alert("âš ï¸ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥");
    return;
  }

  const normalizeSimple = str => (str || "").toLowerCase().replace(/[\s\-\_\.,\/\(\)\[\]#]/g, "");
  const kwNormalized = normalizeSimple(kwLower);

  const res = Object.keys(lampData).filter(id => {
    const d = lampData[id];
    const fields = [d.ê³ ìœ ì´ë¦„, d.ì „í™”ë²ˆí˜¸, d.ì£¼ì†Œ, d.ë¶„ë¥˜, d.íŠ¹ì´ì‚¬í•­];
    return fields.some(field => {
      const text = (field || "").toLowerCase();
      const textNorm = normalizeSimple(text);
      return (
        text.includes(kwLower) ||
        textNorm.includes(kwNormalized) ||
        isSequenceMatch(text, kwLower) ||
        isSequenceMatch(textNorm, kwNormalized)
      );
    });
  }).map(id => ({ id, pos: parseCoords(lampData[id].ì¢Œí‘œ) }));

  if (res.length === 0) {
    alert("âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
    return;
  }

  const bounds = new google.maps.LatLngBounds();
  res.forEach(r => {
    addMarker(r.id, r.pos, "blue");
    bounds.extend(r.pos);
  });
  map.fitBounds(bounds);
}

/* âœ… ê²€ìƒ‰ ì´ˆê¸°í™” */
function resetSearch() {
  searchMode = false; // ğŸ”¹ ê²€ìƒ‰ ëª¨ë“œ í•´ì œ
  clearMarkers();

  // ğŸ”¹ í‚¤ì›Œë“œ ì…ë ¥ì°½ ì´ˆê¸°í™”
  document.getElementById("keyword").value = "";

  // í´ë¦­ ì¢Œí‘œ ì´ˆê¸°í™”
  lastClickedCoord = "";
  document.getElementById("clickedCoords").innerText = "ğŸ“";

  // ê¸°ì¡´ í´ë¦­ ë§ˆì»¤ ì œê±°
  if (window.lastClickMarker) {
    window.lastClickMarker.setMap(null);
    window.lastClickMarker = null;
  }

  // ì§€ë„ ì›ë˜ ì¤‘ì‹¬/ì¤Œìœ¼ë¡œ ë³µê·€
  map.setCenter({ lat: 37.3857, lng: 126.6586 });
  map.setZoom(15);
}

/* âœ… ê¸¸ì°¾ê¸° ë²„íŠ¼ */
function navigateToPatrol(){
  if(!lastClickedCoord){ alert("âš ï¸ ë¨¼ì € ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
  const [lat,lng]=lastClickedCoord.split(",");
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");
}

/* âœ… ğŸ“Œ ìˆœì°° ì™„ë£Œ â†’ ë¡œê·¸ íŒŒì¼ì— append */
function completePatrol(){
  if(!activePatrol){ alert("ğŸš« ì§„í–‰ ì¤‘ì¸ ìˆœì°°ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  completedPatrols.add(activePatrol.key);
  saveCompletedPatrols();

  const patrolId = activePatrol.task.id;  // (ì˜ˆ: "CV11(41í˜¸)")
  const data = lampData[patrolId];
  const patrolTime = new Date().toLocaleString("ko-KR");
  const logLine = `ì•„ì´ë””: ${patrolId}, ìˆœì°°ì‹œê°„: ${patrolTime}, ê³ ìœ ì´ë¦„: ${data?.ê³ ìœ ì´ë¦„ || "ì´ë¦„ ì •ë³´ ì—†ìŒ"},  ì£¼ì†Œ: ${data?.ì£¼ì†Œ || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ"}\n`;


 // ë³€ê²½ëœ ë¶€ë¶„: ë‚ ì§œë³„ í‚¤ ì‚¬ìš©
  const todayKey = "patrol_text_log_" + new Date().toISOString().slice(0,10);
  const existingLog = localStorage.getItem(todayKey) || "";
  const newLog = existingLog + logLine;
  localStorage.setItem(todayKey, newLog);

  // âœ… í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([newLog], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "patrol_log.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  alert(`âœ… ${activePatrol.task.id} (${activePatrol.key.split("|")[1]}) ìˆœì°° ì™„ë£Œ!`);
  activePatrol=null;
  showUpcomingPatrols();
}


/* âœ… ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("upcomingPanel").addEventListener("click",e=>{
    if(e.target.tagName.toLowerCase()!=="li") e.currentTarget.classList.toggle("hidden");
  });
});


window.onload=()=>{ initMap(); showUpcomingPatrols(); setInterval(showUpcomingPatrols,300000); };
</script>

</body>
</html>
